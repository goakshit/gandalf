version: "3"
services:
    db:
        image: "postgres:11"
        container_name: "billingdb-service"
        environment:
            - POSTGRES_DB=billingdb
            - POSTGRES_USER=dev
            - POSTGRES_HOST_AUTH_METHOD=trust
        ports:
            - "5432:5432"
        volumes:
            # Mac postgres mapped to linux postgres
            - /usr/local/var/postgres:/var/lib/postgresql/data
        networks:
            - backend
    billing:
        hostname: billing
        build:
            context: ../..
            dockerfile: ./build/docker/billing/Dockerfile
        environment:
            - POSTGRES_USER=dev
            - POSTGRES_HOST=db
            - KAFKA_SERVER=kafka-1:19091,kafka-1:19092,kafka-2:19092,kafka-2:29091,kafka-3:19092,kafka-3:39091
        container_name: "billing-service"
        ports:
            - 80:80
        depends_on:
            - zk1
            - zk2
            - zk3
            - kafka-1
            - kafka-2
            - kafka-3
            - db
        networks:
            - backend
    zk1:
        image: confluentinc/cp-zookeeper:5.4.3
        ports: 
            - "22181:22181"
        environment:
            ZOOKEEPER_SERVER_ID: 1
            ZOOKEEPER_CLIENT_PORT: 22181
            ZOOKEEPER_TICK_TIME: 2000
            ZOOKEEPER_INIT_LIMIT: 5
            ZOOKEEPER_SYNC_LIMIT: 2
            ZOOKEEPER_SERVERS: zk1:22888:23888;zk2:32888:33888;zk3:42888:43888
        networks:
            - backend
    
    zk2:
        image: confluentinc/cp-zookeeper:5.4.3
        ports:
            - "32181:32181"
        environment:
            ZOOKEEPER_SERVER_ID: 2
            ZOOKEEPER_CLIENT_PORT: 32181
            ZOOKEEPER_TICK_TIME: 2000
            ZOOKEEPER_INIT_LIMIT: 5
            ZOOKEEPER_SYNC_LIMIT: 2
            ZOOKEEPER_SERVERS: zk1:22888:23888;zk2:32888:33888;zk3:42888:43888
        networks:
            - backend
    
    zk3:
        image: confluentinc/cp-zookeeper:5.4.3
        ports: 
            - "42181:42181"
        environment:
            ZOOKEEPER_SERVER_ID: 3
            ZOOKEEPER_CLIENT_PORT: 42181
            ZOOKEEPER_TICK_TIME: 2000
            ZOOKEEPER_INIT_LIMIT: 5
            ZOOKEEPER_SYNC_LIMIT: 2
            ZOOKEEPER_SERVERS: zk1:22888:23888;zk2:32888:33888;zk3:42888:43888
        networks:
            - backend
    
    kafka-1:
        image: confluentinc/cp-kafka:5.4.3
        ports:
            - "19092:19092"
            - "19091:19091"
        depends_on:
            - zk1
            - zk2
            - zk3
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zk1:22181,zk2:32181,zk3:42181
            KAFKA_LISTENERS: LISTENER_INTERNAL://kafka-1:19092,LISTENER_EXTERNAL://kafka-1:19091
            KAFKA_ADVERTISED_LISTENERS: LISTENER_INTERNAL://kafka-1:19092,LISTENER_EXTERNAL://localhost:19091
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: LISTENER_INTERNAL:PLAINTEXT,LISTENER_EXTERNAL:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: LISTENER_INTERNAL
        networks:
            - backend

    kafka-2:
        image: confluentinc/cp-kafka:5.4.3
        ports:
            - "29092:29092"
            - "29091:29091"
        depends_on:
            - zk1
            - zk2
            - zk3
        environment:
            KAFKA_BROKER_ID: 2
            KAFKA_ZOOKEEPER_CONNECT: zk1:22181,zk2:32181,zk3:42181
            KAFKA_LISTENERS: LISTENER_INTERNAL://kafka-2:19092,LISTENER_EXTERNAL://kafka-2:29091
            KAFKA_ADVERTISED_LISTENERS: LISTENER_INTERNAL://kafka-2:19092,LISTENER_EXTERNAL://localhost:29091
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: LISTENER_INTERNAL:PLAINTEXT,LISTENER_EXTERNAL:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: LISTENER_INTERNAL
        networks:
            - backend
    
    kafka-3:
        image: confluentinc/cp-kafka:5.4.3
        ports: 
            - "39092:39092"
            - "39091:39091"
        depends_on:
            - zk1
            - zk2
            - zk3
        environment:
            KAFKA_BROKER_ID: 3
            KAFKA_ZOOKEEPER_CONNECT: zk1:22181,zk2:32181,zk3:42181
            KAFKA_LISTENERS: LISTENER_INTERNAL://kafka-3:19092,LISTENER_EXTERNAL://kafka-3:39091
            KAFKA_ADVERTISED_LISTENERS: LISTENER_INTERNAL://kafka-3:19092,LISTENER_EXTERNAL://localhost:39091
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: LISTENER_INTERNAL:PLAINTEXT,LISTENER_EXTERNAL:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: LISTENER_INTERNAL
        networks:
            - backend
    # zookeeper:
    #     image: confluentinc/cp-zookeeper:5.4.3
    #     ports: 
    #         - "22181:22181"
    #     environment:
    #         - ZOOKEEPER_SERVER_ID=1
    #         - ZOOKEEPER_CLIENT_PORT=22181
    #         - ZOOKEEPER_TICK_TIME=2000
    #         - ZOOKEEPER_INIT_LIMIT=5
    #         - ZOOKEEPER_SYNC_LIMIT=2
    #         - ZOOKEEPER_SERVERS=zookeeper:22888:23888
    #     networks:
    #         - backend

    # kafka:
    #     image: confluentinc/cp-kafka:5.4.3
    #     ports:
    #         - "19092:19092"
    #         - "19091:19091"
    #     depends_on:
    #         - zookeeper
    #     environment:
    #         - KAFKA_BROKER_ID=1
    #         - KAFKA_ZOOKEEPER_CONNECT=zookeeper:22181
    #         - KAFKA_LISTENERS=LISTENER_INTERNAL://kafka:19092,LISTENER_EXTERNAL://kafka:19091
    #         - KAFKA_ADVERTISED_LISTENERS=LISTENER_INTERNAL://kafka:19092,LISTENER_EXTERNAL://kafka:19091
    #         - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=LISTENER_INTERNAL:PLAINTEXT,LISTENER_EXTERNAL:PLAINTEXT
    #         - KAFKA_INTER_BROKER_LISTENER_NAME=LISTENER_INTERNAL
    #     networks:
    #         - backend
networks:
    backend:
        driver: bridge